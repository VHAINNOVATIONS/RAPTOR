<!DOCTYPE html>  <html> <head>   <title>speakeasy.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               speakeasy.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>speakeasy</h1>

<h3>HMAC One-Time Password module for Node.js, supporting counter-based and time-based moving factors</h3>

<p>speakeasy makes it easy to implement HMAC one-time passwords, supporting both counter-based (HOTP)
and time-based moving factors (TOTP). It's useful for implementing two-factor authentication.
Google and Amazon use TOTP to generate codes for use with multi-factor authentication.</p>

<p>speakeasy also supports base32 keys/secrets, by passing <code>base32</code> in the <code>encoding</code> option.
This is useful since Google Authenticator, Google's two-factor authentication mobile app
available for iPhone, Android, and BlackBerry, uses base32 keys.</p>

<p>This module was written to follow the RFC memos on HTOP and TOTP:</p>

<ul>
<li>HOTP (HMAC-Based One-Time Password Algorithm): <a href="http://tools.ietf.org/html/rfc4226">RFC 4226</a></li>
<li>TOTP (Time-Based One-Time Password Algorithm): <a href="http://tools.ietf.org/html/rfc6238">RFC 6238</a></li>
</ul>

<p>One other useful function that this module has is a key generator, which allows you to
generate keys, get them back in their ASCII, hexadecimal, and base32 representations.
In addition, it also can automatically generate QR codes for you, as well as the specialized
QR code you can use to scan in the Google Authenticator mobile app.</p>

<p>An overarching goal of this module, other than to make it very easy to implement the
HOTP and TOTP algorithms, is to be extensively documented. Indeed, it is well-documented,
with clear functions and parameter explanations.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">crypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;crypto&#39;</span><span class="p">),</span>
    <span class="nx">ezcrypto</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;ezcrypto&#39;</span><span class="p">).</span><span class="nx">Crypto</span><span class="p">,</span>
    <span class="nx">base32</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;thirty-two&#39;</span><span class="p">);</span>

<span class="nx">speakeasy</span> <span class="o">=</span> <span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>speakeasy.hotp(options)</p>

<p>Calculates the one-time password given the key and a counter.</p>

<p>options.key                  the key
       .counter              moving factor
       .length(=6)           length of the one-time password (default 6)
       .encoding(='ascii')   key encoding (ascii, hex, or base32)</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">speakeasy</span><span class="p">.</span><span class="nx">hotp</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>set vars</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">counter</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">counter</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="mi">6</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">encoding</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">encoding</span> <span class="o">||</span> <span class="s1">&#39;ascii&#39;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>preprocessing: convert to ascii if it's not</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">encoding</span> <span class="o">==</span> <span class="s1">&#39;hex&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">key</span> <span class="o">=</span> <span class="nx">speakeasy</span><span class="p">.</span><span class="nx">hex_to_ascii</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">encoding</span> <span class="o">==</span> <span class="s1">&#39;base32&#39;</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">key</span> <span class="o">=</span> <span class="nx">base32</span><span class="p">.</span><span class="nx">decode</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>init hmac with the key</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">hmac</span> <span class="o">=</span> <span class="nx">crypto</span><span class="p">.</span><span class="nx">createHmac</span><span class="p">(</span><span class="s1">&#39;sha1&#39;</span><span class="p">,</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">key</span><span class="p">));</span>
  </pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>create an octet array from the counter</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">octet_array</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">Array</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>

  <span class="kd">var</span> <span class="nx">counter_temp</span> <span class="o">=</span> <span class="nx">counter</span><span class="p">;</span>

  <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">i_from_right</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">-</span> <span class="nx">i</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>mask 255 over number to get last 8</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">octet_array</span><span class="p">[</span><span class="nx">i_from_right</span><span class="p">]</span> <span class="o">=</span> <span class="nx">counter_temp</span> <span class="o">&amp;</span> <span class="mi">255</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>shift 8 and get ready to loop over the next batch of 8</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">counter_temp</span> <span class="o">=</span> <span class="nx">counter_temp</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>create a buffer from the octet array</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">counter_buffer</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Buffer</span><span class="p">(</span><span class="nx">octet_array</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>update hmac with the counter</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">hmac</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">counter_buffer</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>get the digest in hex format</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">digest</span> <span class="o">=</span> <span class="nx">hmac</span><span class="p">.</span><span class="nx">digest</span><span class="p">(</span><span class="s1">&#39;hex&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>convert the result to an array of bytes</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">digest_bytes</span> <span class="o">=</span> <span class="nx">ezcrypto</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">hexToBytes</span><span class="p">(</span><span class="nx">digest</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>compute HOTP
get offset</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">offset</span> <span class="o">=</span> <span class="nx">digest_bytes</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>calculate bin_code (RFC4226 5.4)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">bin_code</span> <span class="o">=</span> <span class="p">(</span><span class="nx">digest_bytes</span><span class="p">[</span><span class="nx">offset</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span>   <span class="o">&lt;&lt;</span> <span class="mi">24</span>
                <span class="o">|</span><span class="p">(</span><span class="nx">digest_bytes</span><span class="p">[</span><span class="nx">offset</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span>
                <span class="o">|</span><span class="p">(</span><span class="nx">digest_bytes</span><span class="p">[</span><span class="nx">offset</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span>
                <span class="o">|</span><span class="p">(</span><span class="nx">digest_bytes</span><span class="p">[</span><span class="nx">offset</span><span class="o">+</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

  <span class="nx">bin_code</span> <span class="o">=</span> <span class="nx">bin_code</span><span class="p">.</span><span class="nx">toString</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>get the chars at position bin_code - length through length chars</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">sub_start</span> <span class="o">=</span> <span class="nx">bin_code</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">length</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">code</span> <span class="o">=</span> <span class="nx">bin_code</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="nx">sub_start</span><span class="p">,</span> <span class="nx">length</span><span class="p">);</span>
  </pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>we now have a code with <code>length</code> number of digits, so return it</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">return</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>speakeasy.totp(options)</p>

<p>Calculates the one-time password given the key, based on the current time
with a 30 second step (step being the number of seconds between passwords).</p>

<p>options.key                  the key
       .length(=6)           length of the one-time password (default 6)
       .encoding(='ascii')   key encoding (ascii, hex, or base32)
       .step(=30)            override the step in seconds
       .time_now             (optional) override the time to calculate with</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">speakeasy</span><span class="p">.</span><span class="nx">totp</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>set vars</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">key</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="mi">6</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">encoding</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">encoding</span> <span class="o">||</span> <span class="s1">&#39;ascii&#39;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">step</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">step</span> <span class="o">||</span> <span class="mi">30</span><span class="p">;</span>
  </pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>get current time in seconds since unix epoch</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">time_now</span> <span class="o">=</span> <span class="nb">parseInt</span><span class="p">(</span><span class="nb">Date</span><span class="p">.</span><span class="nx">now</span><span class="p">()</span><span class="o">/</span><span class="mi">1000</span><span class="p">);</span>
  </pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>are we forcing a specific time?</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">time_now</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>override the time</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">time_now</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">time_now</span><span class="p">;</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>calculate counter value</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">counter</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nx">time_now</span> <span class="o">/</span> <span class="nx">step</span><span class="p">);</span>
  </pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>pass to hotp</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">code</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">hotp</span><span class="p">({</span><span class="nx">key</span><span class="o">:</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">length</span><span class="o">:</span> <span class="nx">length</span><span class="p">,</span> <span class="nx">encoding</span><span class="o">:</span> <span class="nx">encoding</span><span class="p">,</span> <span class="nx">counter</span><span class="o">:</span> <span class="nx">counter</span><span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>return the code</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">return</span><span class="p">(</span><span class="nx">code</span><span class="p">);</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>speakeasy.hex<em>to</em>ascii(key)</p>

<p>helper function to convert a hex key to ascii.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">speakeasy</span><span class="p">.</span><span class="nx">hex_to_ascii</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>key is a string of hex
convert it to an array of bytes...</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">bytes</span> <span class="o">=</span> <span class="nx">ezcrypto</span><span class="p">.</span><span class="nx">util</span><span class="p">.</span><span class="nx">hexToBytes</span><span class="p">(</span><span class="nx">str</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>bytes is now an array of bytes with character codes
merge this down into a string</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">ascii_string</span> <span class="o">=</span> <span class="k">new</span> <span class="nb">String</span><span class="p">();</span>

  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">bytes</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ascii_string</span> <span class="o">+=</span> <span class="nb">String</span><span class="p">.</span><span class="nx">fromCharCode</span><span class="p">(</span><span class="nx">bytes</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">ascii_string</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>speakeasy.ascii<em>to</em>hex(key)</p>

<p>helper function to convert an ascii key to hex.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">speakeasy</span><span class="p">.</span><span class="nx">ascii_to_hex</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">str</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">hex_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
  
  <span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">str</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">hex_string</span> <span class="o">+=</span> <span class="nx">str</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">hex_string</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>speakeasy.generate_key(options)</p>

<p>Generates a random key with the set A-Z a-z 0-9 and symbols, of any length
(default 32). Returns the key in ASCII, hexadecimal, and base32 format.
Base32 format is used in Google Authenticator. Turn off symbols by setting
symbols: false. Automatically generate links to QR codes of each encoding
(using the Google Charts API) by setting qr_codes: true. Automatically
generate a link to a special QR code for use with the Google Authenticator
app, for which you can also specify a name.</p>

<p>options.length(=32)              length of key
       .symbols(=true)           include symbols in the key
       .qr<em>codes(=false)         generate links to QR codes
       .google</em>auth_qr(=false)   generate a link to a QR code to scan
                                 with the Google Authenticator app.
       .name                     (optional) add a name. no spaces.
                                 for use with Google Authenticator</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">speakeasy</span><span class="p">.</span><span class="nx">generate_key</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>options</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">length</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">length</span> <span class="o">||</span> <span class="mi">32</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">name</span> <span class="o">||</span> <span class="s2">&quot;Secret Key&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">qr_codes</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">qr_codes</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">google_auth_qr</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">google_auth_qr</span> <span class="o">||</span> <span class="kc">false</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>turn off symbols only when explicity told to</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">symbols</span> <span class="o">&amp;&amp;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">symbols</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">symbols</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nx">symbols</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>generate an ascii key</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">generate_key_ascii</span><span class="p">(</span><span class="nx">length</span><span class="p">,</span> <span class="nx">symbols</span><span class="p">);</span>
  </pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>return a SecretKey with ascii, hex, and base32</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">SecretKey</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="nx">SecretKey</span><span class="p">.</span><span class="nx">ascii</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span>
  <span class="nx">SecretKey</span><span class="p">.</span><span class="nx">hex</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">ascii_to_hex</span><span class="p">(</span><span class="nx">key</span><span class="p">);</span>
  <span class="nx">SecretKey</span><span class="p">.</span><span class="nx">base32</span> <span class="o">=</span> <span class="nx">base32</span><span class="p">.</span><span class="nx">encode</span><span class="p">(</span><span class="nx">key</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/=/g</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
  </pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>generate some qr codes if requested</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">qr_codes</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">SecretKey</span><span class="p">.</span><span class="nx">qr_code_ascii</span> <span class="o">=</span> <span class="s1">&#39;https://www.google.com/chart?chs=166x166&amp;chld=L|0&amp;cht=qr&amp;chl=&#39;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">SecretKey</span><span class="p">.</span><span class="nx">ascii</span><span class="p">);</span>
    <span class="nx">SecretKey</span><span class="p">.</span><span class="nx">qr_code_hex</span> <span class="o">=</span> <span class="s1">&#39;https://www.google.com/chart?chs=166x166&amp;chld=L|0&amp;cht=qr&amp;chl=&#39;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">SecretKey</span><span class="p">.</span><span class="nx">hex</span><span class="p">);</span>
    <span class="nx">SecretKey</span><span class="p">.</span><span class="nx">qr_code_base32</span> <span class="o">=</span> <span class="s1">&#39;https://www.google.com/chart?chs=166x166&amp;chld=L|0&amp;cht=qr&amp;chl=&#39;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">SecretKey</span><span class="p">.</span><span class="nx">base32</span><span class="p">);</span>
  <span class="p">}</span>
  </pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>generate a QR code for use in Google Authenticator if requested
(Google Authenticator has a special style and requires base32)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="p">(</span><span class="nx">google_auth_qr</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>first, make sure that the name doesn't have spaces, since Google Authenticator doesn't like them</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">name</span> <span class="o">=</span> <span class="nx">name</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/ /g</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">);</span>
    <span class="nx">SecretKey</span><span class="p">.</span><span class="nx">google_auth_qr</span> <span class="o">=</span> <span class="s1">&#39;https://www.google.com/chart?chs=166x166&amp;chld=L|0&amp;cht=qr&amp;chl=otpauth://totp/&#39;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;%3Fsecret=&#39;</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">SecretKey</span><span class="p">.</span><span class="nx">base32</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="k">return</span> <span class="nx">SecretKey</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>speakeasy.generate<em>key</em>ascii(length, symbols)</p>

<p>Generates a random key, of length <code>length</code> (default 32).
Also choose whether you want symbols, default false.
speakeasy.generate_key() wraps around this.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">speakeasy</span><span class="p">.</span><span class="nx">generate_key_ascii</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">length</span><span class="p">,</span> <span class="nx">symbols</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">length</span><span class="p">)</span> <span class="nx">length</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">set</span> <span class="o">=</span> <span class="s1">&#39;0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz&#39;</span><span class="p">;</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">symbols</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">set</span> <span class="o">+=</span> <span class="s1">&#39;!@#$%^&amp;*()&lt;&gt;?/[]{},.:;&#39;</span><span class="p">;</span>
  <span class="p">}</span>
  
  <span class="kd">var</span> <span class="nx">key</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>

  <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">key</span> <span class="o">+=</span> <span class="nx">set</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="nx">set</span><span class="p">.</span><span class="nx">length</span><span class="p">));</span>
  <span class="p">}</span>
  
  <span class="k">return</span> <span class="nx">key</span><span class="p">;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>alias, not the TV show</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">speakeasy</span><span class="p">.</span><span class="nx">counter</span> <span class="o">=</span> <span class="nx">speakeasy</span><span class="p">.</span><span class="nx">hotp</span><span class="p">;</span>
<span class="nx">speakeasy</span><span class="p">.</span><span class="nx">time</span> <span class="o">=</span> <span class="nx">speakeasy</span><span class="p">.</span><span class="nx">totp</span><span class="p">;</span>

<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="nx">speakeasy</span><span class="p">;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 